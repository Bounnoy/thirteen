<!DOCTYPE html>
<html lang="en">
  <head>
    <title>13</title>
    <!-- Note from Bounnoy: Template was made with Bootstrap's Jumbotron theme. -->
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=0" />
    <meta name="description" content="Thirteen: A turn-based pattern matching card game.">
    <meta name="author" content="Bounnoy Phanthavong">

    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
		<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/css/bootstrap.min.css" />
		<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.2/socket.io.js"></script>
    <!--<script type="text/javascript" src="http://localhost:8000/socket.io/socket.io.js"></script>-->
    <style type="text/css">
			.navbar {
				margin-bottom:30px;
			}
		</style>
  </head>
  <body>
    <nav class="navbar navbar-expand-md navbar-dark static-top bg-dark">
      <a class="navbar-brand" href="#">THIRTEEN</a>

      <div class="collapse navbar-collapse" id="navbarsExampleDefault">
        <ul class="navbar-nav mr-auto">
          <li class="nav-item active">
            <a class="nav-link" href="#">home</a>
          </li><!--
          <li class="nav-item">
            <a class="nav-link" href="#">rules</a>
          </li>
					<li class="nav-item">
            <a class="nav-link" href="#">patterns</a>
          </li>-->
        </ul>

				<ul class="navbar-nav my-2 my-lg-0">
          <li class="nav-item">
            <a class="nav-link" href="#">register</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#">login</a>
          </li>
        </ul>

      </div>
    </nav>

    <main role="main">

      <div class="container">
        <!-- Opponent Deck -->
        <div class="row">
          <div class="col-md-4">
            <h5 align="center">Player 2</h5>
            <p align="center" id="p2"></p>
          </div>
          <div class="col-md-4">
            <h5 align="center">Player 3</h5>
            <p align="center" id="p3"></p>
          </div>
          <div class="col-md-4">
            <h5 align="center">Player 4</h5>
            <p align="center" id="p4"></p>
          </div>
        </div>

      <!-- Main jumbotron for a primary marketing message or call to action -->
      <div class="jumbotron">
        <div class="container" align="center" id='pile'>
          <!-- Game area. -->


        </div>
      </div>

      <div class="container">
        <!-- Player Deck -->
        <div class="row">
          <div id="playerDeck" class="display-inline" style="margin: auto; text-align: center">
            <div id="playerBtn"></div>
            <button id="btnReset" type="button" class="btn btn-primary mr-2 mb-2">Reset</button>
            <button id="btnSkip" type="button" class="btn btn-primary mr-2 mb-2">Skip</button>
            <button id="btnPlay" type="button" class="btn btn-primary mr-2 mb-2">Play</button>
          </div>

          <div class="col-md-12" align="center" id='pDeck'>
          </div>
        </div>

        <hr>

      </div> <!-- /container -->

    </main>

    <footer class="container">
      <p><a href="https://github.com/Bounnoy">Bounnoy Phanthavong</a> @ <a href="https://www.pdx.edu/">Portland State University</a>. All rights reserved.</p>
    </footer>
    <script type="text/javascript">
      var toPlay = [];

      var socket = io.connect('http://192.168.1.128:8000');
      //var socket = io.connect('http://192.168.0.12:8000');

      socket.on('cpu', function(sData) {
        $('#p2').text(sData.p2);
        if (sData.p2move) $('#p2').append('<br>' + sData.p2move.join(', '));
        $('#p3').text(sData.p3);
        if (sData.p3move) $('#p3').append('<br>' + sData.p3move.join(', '));
        $('#p4').text(sData.p4);
        if (sData.p4move) $('#p4').append('<br>' + sData.p4move.join(', '));
      });

      socket.on('pile', function(sData) {
        $('#pile').empty();
        for (var i = 0; i < sData.length; i++) {
          if (i === 6) $('#pDeck').append('<br>');

          $(document.createElement("img"))
              .attr({ src: sData[i].image, style: "width: 10%; margin: 2px" })
              .appendTo('#pile');
        }
      });

      socket.on('turn', function(sData) {
        if (sData.turn.player === socket.id) {
          $('#playerBtn').empty();
          $('#btnReset').show();
          if (sData.turn.pattern != '0') {
            $('#btnSkip').show();
          } else {
            $('#playerBtn').prepend(`<p>No one else can go, play any pattern.</p>`);
          }
          $('#btnPlay').show();
        } else {
          $('#playerBtn').empty().prepend(`<p>${sData.turn.player}'s turn...</p>`);
          $('#btnReset').hide();
          $('#btnSkip').hide();
          $('#btnPlay').hide();
        }
      });

      socket.on('win', function(sData) {
        $('#btnReset').hide();
        $('#btnSkip').hide();
        $('#btnPlay').hide();
        $('#playerBtn').empty().prepend(`<p style="color: "#d4f">${sData.message}</p>`);
        $('#playerDeck').append('<button id="newGame" type="button" class="btn btn-primary mr-2 mb-2">Play Again</button>');
        // $(document.createElement("img"))
        //     .attr({ src: sData[i].image, style: "width: 10%; margin: 2px" })
        //     .appendTo('#pile');
      });

      socket.on('game', function(sData) {
        toPlay.length = 0;
        $('#playerBtn').empty();
        $('#pDeck').empty();
        for (var i = 0; i < sData.length; i++) {
          if (i === 6) $('#pDeck').append('<br>');

          $(document.createElement("img"))
              .attr({ src: sData[i].image, style: "width: 10%; margin: 2px" })
              .appendTo('#pDeck')
              .data({'code': sData[i].code, 'select': false})
              .click(function() {
                  if ($(this).data('select') === false) {
                    $(this).data('select', true);
                    $(this).css({
                      'border': "solid 1px #d4f",
                      'border-radius': "5px",
                      'box-shadow': "0 0 9px #caf"
                    });

                    toPlay.push($(this).data('code'));
                  } else {
                    $(this).data('select', false);
                    $(this).css({
                      'border': "none",
                      'box-shadow': "0 0 0"
                    });

                    for (var i = 0; i < toPlay.length; i++) {
            					if (toPlay[i] === $(this).data('code')) {
            						toPlay.splice(i, 1);
            					}
            				}
                  }
                  console.log($(this).data('code'));
                  console.log($(this).data('select'));
                  console.log(toPlay);
              });
        }
      });

      socket.on('badPattern', (mes) => {
        $('#playerBtn').empty().prepend('<p style="color: red">' + mes.message + '</p>');
      });

      $('#btnPlay').on('click', () => {
        socket.emit('play', toPlay);
      });

      $('#btnSkip').on('click', () => {
        socket.emit('skip');
      });

      $('#newGame').on('click', () => {
        socket.emit('newGame');
        $('#newGame').detach();
      })

    </script>
  </body>
</html>
